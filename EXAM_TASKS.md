| Archivo | Qué se debe hacer | Cómo hacerlo (resumen) |
|---|---|---|
| `backend/src/sessions/sessions.service.ts` | Completar método `book` para detectar solapes por `roomId` y por `userId` | Convertir `start/end` a milisegundos, recorrer sesiones existentes y verificar solape: `(start < existingEnd) && (end > existingStart)`. Si hay conflicto, lanzar `BadRequestException({ message: 'Session overlap', code: 'SESSION_OVERLAP', details: [{ conflictWithSessionId }] })`. Mantener el resto del flujo intacto. |
| `backend/src/auth/roles.guard.ts` | Validar expiración estándar del JWT y roles requeridos (desde `@SetMetadata('roles', [...])`) | Leer `Authorization`, verificar con `JwtService.verify` (firma y expiración). Si el token expiró → `UnauthorizedException`. Si faltan roles requeridos → `ForbiddenException`. Permitir acceso solo si pasa ambas validaciones. |
| `backend/src/puzzle-scores/dto/create-puzzle-score.dto.ts` | Agregar validaciones: `score` 0–100; si `isFinal` es true, `score >= 70`; si `attempt > 1`, `score >= previousScore` | Usar `class-validator` (`@Min(0)`, `@Max(100)`), validación a nivel de clase con custom validator (o en servicio) para `isFinal`. Para `attempt > 1`, consultar el puntaje anterior mediante el servicio expuesto (stub) y comparar. Responder con mensajes claros de validación. |
| `frontend/src/app/auth/auth.guard.ts` | Proteger rutas: leer `data.roles`, validar token (exp estándar) y roles; redirigir a `/login` con `returnUrl` | Usar `jwt-decode` para leer `exp` y `roles`. Si no hay token/expiró o faltan roles, mostrar `MatSnackBar` y `Router.navigate(['/login'], { queryParams: { returnUrl } })`. Permitir acceso si todo es válido. |
| `frontend/src/app/core/interceptors/auth.interceptor.ts` | Adjuntar `Authorization`; manejar `401` limpiando sesión y redirigiendo a login | Clonar la petición con `req.clone({ setHeaders: {...} })`. En errores, si `status === 401`, `localStorage.removeItem('token')` y redirigir a `/login`. |
| `frontend/src/app/sessions/sessions.component.ts` | Form reactivo con validaciones cruzadas y carga de datos con RxJS | Crear `FormGroup` con `roomId/start/end` y validadores: `start < end` y duración mínima 30 min. Filtros observables (`roomId$`, `dateRange$`) combinados con `combineLatest`, luego `switchMap` a `HttpClient` para listar. Conectar resultado a `MatTableDataSource` y `MatPaginator/MatSort`. Manejar `SESSION_OVERLAP` resaltando errores y mostrando `MatSnackBar`. |
| `frontend/src/app/sessions/sessions.component.html` | Construir la vista de filtros, tabla y formulario de reserva con Angular Material | Usar `mat-form-field`, `mat-select`, inputs `datetime-local`, `mat-table` con columnas Sala/Inicio/Fin/Estado/Acción, y `mat-paginator`. Botón “Reservar” que usa el form. Mostrar `mat-error` en validaciones. |
| `frontend/src/app/sessions/sessions.component.scss` | Estilos base para la vista de sesiones | Definir layout sencillo (fila de filtros con `gap`, margenes para `mat-card`, etc.). No se requiere responsive. |
| `frontend/src/app/puzzle-scores/puzzle-scores.component.ts` | Implementar formulario para rol `gm` y enviar puntaje | `FormGroup` con `sessionId`, `attempt`, `score`, `isFinal`. Validar rango 0–100 en UI. Enviar a `POST /api/puzzle-scores`. Mostrar `MatSnackBar` de éxito/error. |
 | `frontend/src/app/puzzle-scores/puzzle-scores.component.ts` | Cambiar el campo “Sesión ID” por un select de sesiones disponibles | Consumir `GET /api/sessions` al inicializar el componente, construir opciones tipo “Sala — inicio a fin” y usar `mat-select` con `formControlName="sessionId"`. Manejar estados de carga/errores con `MatSnackBar`. Seleccionar el `id` de la sesión como valor. |
 | `backend/src/puzzle-scores/puzzle-scores.controller.ts` | Agregar endpoint de listado de puntajes `GET /api/puzzle-scores?sessionId=` | Mantener almacenamiento en memoria. Aceptar filtro `sessionId` (y opcionalmente `userId`). Responder arreglo con campos mínimos: `sessionId`, `attempt`, `score`, `createdAt`. Proteger con `RolesGuard` (rol `gm`) o dejar lectura pública según enunciado. |
 | `frontend/src/app/puzzle-scores/puzzle-scores.component.ts` | Mostrar tabla de puntajes bajo el formulario (listado) | Tras seleccionar la sesión en el `mat-select`, consultar `GET /api/puzzle-scores?sessionId=...` y renderizar `mat-table` con columnas: Intento, Score, Fecha. Indicar estado vacío “Sin resultados”. |

